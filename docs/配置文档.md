# ImageKit 项目完整配置文档

**项目名称：** ImageKit - AI 图片处理平台  
**配置日期：** 2025年11月30日  
**总耗时：** 约 4 小时  
**配置人员：** 卡卡老板 + Cascade AI  

---

## 📋 目录

1. [域名配置](#1-域名配置)
2. [DNS 解析配置](#2-dns-解析配置)
3. [SSL 证书](#3-ssl-证书)
4. [Nginx 服务器](#4-nginx-服务器)
5. [阿里云 OSS](#5-阿里云-oss)
6. [阿里云百炼平台](#6-阿里云百炼平台)
7. [MongoDB Atlas](#7-mongodb-atlas)
8. [Google OAuth](#8-google-oauth)
9. [敏感信息汇总](#9-敏感信息汇总)
10. [待处理事项](#10-待处理事项)

---

## 1. 域名配置

### 基本信息

```
主域名：getimagekit.com
www域名：www.getimagekit.com
API域名：api.getimagekit.com

购买平台：阿里云（Aliyun）
注册商：阿里云计算有限公司
```

### 域名控制台

```
阿里云域名控制台：
https://dc.console.aliyun.com/

管理路径：
控制台首页 → 域名 → 域名列表 → getimagekit.com
```

### 域名用途

| 域名 | 用途 | 说明 |
|------|------|------|
| `getimagekit.com` | 主站（前端） | 用户访问入口，展示产品功能 |
| `www.getimagekit.com` | 主站别名 | 301 重定向到主域名 |
| `api.getimagekit.com` | API 接口 | 后端服务，RESTful API |

### 域名状态

```
✅ 已实名认证
✅ DNS 服务商：阿里云 DNS
✅ HTTPS 已启用
✅ 备案状态：无需备案（国际域名）
```

---

## 2. DNS 解析配置

### DNS 控制台

```
阿里云 DNS 控制台：
https://dns.console.aliyun.com/

当前域名：getimagekit.com
DNS 服务器：阿里云 DNS
```

### DNS 记录详情

| 记录类型 | 主机记录 | 记录值 | TTL | 用途 |
|---------|---------|--------|-----|------|
| A | @ | 8.152.211.36 | 600 | 主域名 |
| A | www | 8.152.211.36 | 600 | www跳转 |
| A | api | 8.152.211.36 | 600 | API接口 |

### 服务器信息

```
服务器 IP：8.152.211.36
服务器位置：阿里云 ECS（华东1 - 杭州）
服务器操作系统：CentOS
```

### DNS 解析验证

```bash
# 验证主域名
ping getimagekit.com
# 返回：8.152.211.36

# 验证 www
ping www.getimagekit.com
# 返回：8.152.211.36

# 验证 API
ping api.getimagekit.com
# 返回：8.152.211.36
```

### DNS 生效时间

```
配置完成：2025-11-30 18:00
生效时间：10-30分钟
当前状态：✅ 已完全生效
```

---

## 3. SSL 证书

### 证书信息

```
证书颁发机构：Let's Encrypt
证书类型：域名验证 (DV) SSL 证书
加密级别：TLS 1.2 / TLS 1.3
证书品牌：Let's Encrypt Authority X3
```

### 证书详情

```
主域名：getimagekit.com
备用域名（SAN）：
  - www.getimagekit.com
  - api.getimagekit.com

签发日期：2025-11-30
到期日期：2026-02-28（90天有效期）
自动续期：❌ 需要手动续期（DNS验证模式）
```

### 证书文件位置（服务器）

```bash
证书目录：/etc/letsencrypt/live/getimagekit.com/

文件列表：
- fullchain.pem  # 完整证书链（Nginx 使用）
- privkey.pem    # 私钥文件（Nginx 使用）
- chain.pem      # 中间证书
- cert.pem       # 域名证书

权限：root:root (600)
```

### 申请方式

```bash
验证方式：DNS-01 挑战（TXT记录验证）
申请工具：Certbot 2.x
申请邮箱：gaozhenglong99@gmail.com

申请命令：
sudo certbot certonly --manual \
  --preferred-challenges dns \
  -d getimagekit.com \
  -d www.getimagekit.com \
  -d api.getimagekit.com \
  --email gaozhenglong99@gmail.com
```

### 证书续期说明

```
⚠️ 重要提醒：
1. Let's Encrypt 证书有效期 90 天
2. 需要在到期前 30 天内续期
3. DNS 验证模式无法自动续期
4. 续期时需要重新添加 TXT 记录

续期提醒日期：2026-01-28
到期日期：2026-02-28

续期命令（到时在服务器执行）：
sudo certbot renew --manual
```

### HTTPS 访问测试

```bash
# 测试主域名
curl -I https://getimagekit.com
# 预期返回：200 OK

# 测试 www（应该301跳转）
curl -I https://www.getimagekit.com
# 预期返回：301 Moved Permanently

# 测试 API
curl -I https://api.getimagekit.com
# 预期返回：502 Bad Gateway（后端未启动时正常）
```

---

## 4. Nginx 服务器

### Nginx 信息

```
版本：Nginx/1.x
安装路径：/usr/local/nginx/
配置文件：/usr/local/nginx/conf/nginx.conf
执行文件：/usr/local/nginx/sbin/nginx
日志目录：/usr/local/nginx/logs/
网站根目录：/usr/local/nginx/getimagekit.com/dist
```

### 运行状态检查

```bash
# 检查进程
ps aux | grep nginx

# 检查端口
sudo netstat -tlnp | grep nginx
# 应该监听：80 和 443

# 查看 Nginx 版本
sudo /usr/local/nginx/sbin/nginx -v
```

### 服务配置详情

#### HTTP 服务（端口 80）

```nginx
# 所有 HTTP 请求重定向到 HTTPS
listen 80;
server_name getimagekit.com www.getimagekit.com api.getimagekit.com;

# Let's Encrypt 验证目录
location /.well-known/acme-challenge/ {
    root /usr/local/nginx/certbot;
}

# 其他请求跳转到 HTTPS
location / {
    return 301 https://getimagekit.com$request_uri;
}
```

#### HTTPS 主站（getimagekit.com）

```nginx
listen 443 ssl;
server_name getimagekit.com;

# SSL 证书
ssl_certificate /etc/letsencrypt/live/getimagekit.com/fullchain.pem;
ssl_certificate_key /etc/letsencrypt/live/getimagekit.com/privkey.pem;
ssl_session_cache shared:SSL:10m;
ssl_session_timeout 10m;

# 网站根目录
root /usr/local/nginx/getimagekit.com/dist;
index index.html;

# 前端路由支持（React Router）
location / {
    try_files $uri $uri/ /index.html;
}

# 静态资源缓存
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

#### HTTPS www 跳转

```nginx
listen 443 ssl;
server_name www.getimagekit.com;

# SSL 证书
ssl_certificate /etc/letsencrypt/live/getimagekit.com/fullchain.pem;
ssl_certificate_key /etc/letsencrypt/live/getimagekit.com/privkey.pem;

# 301 永久跳转到主域名
return 301 https://getimagekit.com$request_uri;
```

#### HTTPS API 服务（api.getimagekit.com）

```nginx
listen 443 ssl;
server_name api.getimagekit.com;

# SSL 证书
ssl_certificate /etc/letsencrypt/live/getimagekit.com/fullchain.pem;
ssl_certificate_key /etc/letsencrypt/live/getimagekit.com/privkey.pem;

# 反向代理到 Node.js 后端
location / {
    proxy_pass http://127.0.0.1:3000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
}

# 文件上传限制：20MB
client_max_body_size 20M;
```

### Nginx 管理命令

```bash
# 测试配置文件语法
sudo /usr/local/nginx/sbin/nginx -t

# 启动 Nginx
sudo /usr/local/nginx/sbin/nginx

# 停止 Nginx
sudo /usr/local/nginx/sbin/nginx -s stop

# 优雅停止（处理完当前请求）
sudo /usr/local/nginx/sbin/nginx -s quit

# 重载配置（不停机）
sudo /usr/local/nginx/sbin/nginx -s reload

# 查看版本
sudo /usr/local/nginx/sbin/nginx -v

# 查看编译参数
sudo /usr/local/nginx/sbin/nginx -V
```

### 日志文件

```
访问日志：
- /usr/local/nginx/logs/access.log（全局）
- /usr/local/nginx/logs/getimagekit.com.access.log（主站）
- /usr/local/nginx/logs/api.getimagekit.com.access.log（API）

错误日志：
- /usr/local/nginx/logs/error.log（全局）
- /usr/local/nginx/logs/getimagekit.com.error.log（主站）
- /usr/local/nginx/logs/api.getimagekit.com.error.log（API）

查看实时日志：
tail -f /usr/local/nginx/logs/access.log
tail -f /usr/local/nginx/logs/error.log
```

---

## 5. 阿里云 OSS

### Bucket 信息

```
Bucket 名称：imagekit-temp
存储类型：标准存储（Standard）
读写权限：私有（Private）
地域节点：华东1（杭州）
区域ID：oss-cn-hangzhou
外网访问：https://imagekit-temp.oss-cn-hangzhou.aliyuncs.com
内网访问：https://imagekit-temp.oss-cn-hangzhou-internal.aliyuncs.com
```

### OSS 控制台

```
阿里云 OSS 控制台：
https://oss.console.aliyun.com/

管理路径：
Bucket 列表 → imagekit-temp → 文件管理/权限设置
```

### 访问凭证（AccessKey）

```
RAM 用户名：imagekit-api
AccessKey ID：your_access_key_id
AccessKey Secret：your_access_key_secret

权限策略：AliyunOSSFullAccess（OSS 完全访问权限）

RAM 控制台：
https://ram.console.aliyun.com/users

⚠️ 安全提示：
- AccessKey 仅存储在后端服务器 .env 文件
- 不要将 AccessKey 提交到 Git 仓库
- 定期轮换 AccessKey（建议每 90 天）
- 不要在前端代码中暴露
```

### CORS 跨域配置

```
规则1：
来源（AllowedOrigin）：
  - https://getimagekit.com
  - https://api.getimagekit.com
  - http://localhost:5173

允许方法（AllowedMethods）：
  - GET
  - POST
  - PUT
  - DELETE
  - HEAD

允许头部（AllowedHeaders）：*
暴露头部（ExposeHeaders）：
  - ETag
  - x-oss-request-id

缓存时间（MaxAgeSeconds）：600
```

### 生命周期规则

```
规则名称：auto-delete-temp
应用范围：整个 Bucket
对象前缀：（空，应用于所有对象）

过期策略：
- 距最后修改时间 7 天后自动删除

碎片过期策略：
- 距创建时间 1 天后删除

目的：
- 自动清理临时图片文件
- 节省存储费用
- 避免存储空间浪费
```

### 存储目录规划

```
/original/          # 原始上传的图片
/processed/         # 处理后的图片
/temp/              # 临时文件（7天后自动删除）
/thumbnails/        # 缩略图
/watermarks/        # 水印素材
/avatars/           # 用户头像
```

### OSS SDK 使用示例

```javascript
const OSS = require('ali-oss');

const client = new OSS({
  region: 'oss-cn-hangzhou',
  accessKeyId: process.env.ALIYUN_OSS_ACCESS_KEY_ID,
  accessKeySecret: process.env.ALIYUN_OSS_ACCESS_KEY_SECRET,
  bucket: 'imagekit-temp'
});

// 上传文件
await client.put('temp/test.jpg', './test.jpg');

// 生成签名 URL（有效期 1 小时）
const url = client.signatureUrl('temp/test.jpg', {
  expires: 3600
});

// 删除文件
await client.delete('temp/test.jpg');
```

### 费用估算

```
存储费用：0.12 元/GB/月
流量费用：
  - 内网流出：免费
  - 公网流出：0.5 元/GB
请求费用：0.01 元/万次

预估月费用（10GB存储 + 100GB流量）：
- 存储：10 × 0.12 = 1.2 元
- 流量：100 × 0.5 = 50 元
- 请求：忽略不计
- 合计：约 51.2 元/月
```

---

## 6. 阿里云百炼平台

### 服务信息

```
服务名称：阿里云百炼（原灵积 DashScope）
服务类型：AI 大模型平台
产品定位：企业级 AI 服务平台

官方文档：
https://help.aliyun.com/zh/model-studio/

百炼控制台：
https://bailian.console.aliyun.com/
```

### API 配置

```
API Key：sk-1c8f2ce9054d4b298878faef7335dc24
API 端点：https://dashscope.aliyuncs.com/api/v1/

API 文档：
https://help.aliyun.com/zh/model-studio/developer-reference/

⚠️ 安全提示：
- API Key 仅存储在后端 .env
- 不要在前端或公开代码中暴露
- 可在控制台随时重新生成
- 建议定期轮换
```

### 已开通的模型服务

#### 1. 通义万相（Wanxiang）

```
功能：
- AI 图片生成
- 图片编辑和修复
- 图片风格转换
- 图像修复（Inpainting）

用途：
- 图片去水印
- AI 修复受损区域
- 风格迁移

API 文档：
https://help.aliyun.com/zh/model-studio/developer-reference/tongyi-wanxiang-api

调用示例：
POST https://dashscope.aliyuncs.com/api/v1/services/aigc/image-generation/generation
Authorization: Bearer sk-1c8f2ce9054d4b298878faef7335dc24
Content-Type: application/json

{
  "model": "wanx-inpainting-v1",
  "input": {
    "image_url": "https://example.com/image.jpg",
    "mask_url": "https://example.com/mask.jpg"
  }
}
```

#### 2. 图像分割（Image Segmentation）

```
功能：
- 人像抠图
- 商品抠图
- 背景去除
- 智能分割

用途：
- 快速抠图
- 背景替换
- 图片合成

API 文档：
https://help.aliyun.com/zh/imageseg/
```

#### 3. 图像增强

```
功能：
- 超分辨率（提升画质）
- 图片去噪
- 图片去模糊
- 图像锐化

用途：
- 低质量图片修复
- 老照片修复
- 提升清晰度
```

### 计费说明

```
计费方式：按量付费（后付费）
计费周期：每小时结算
最低充值：10 元

参考价格（可能有变动）：
- 通义万相：约 0.01-0.05 元/次
- 图像分割：约 0.005 元/次
- 图像增强：约 0.01 元/次

充值入口：
百炼控制台 → 右上角"充值"

费用查询：
https://usercenter2.aliyun.com/finance/cost-center
```

### 配额和限制

```
QPS 限制：
- 免费版：10 次/秒
- 付费版：可申请提升到 100 次/秒

文件大小限制：
- 单个图片：最大 10MB
- 图片分辨率：最大 4096 x 4096

超时时间：
- 图片生成：60 秒
- 图片处理：30 秒

并发限制：
- 同时处理：10 个任务
```

### API 调用示例（Node.js）

```javascript
const axios = require('axios');

async function removeWatermark(imageUrl, maskUrl) {
  const response = await axios.post(
    'https://dashscope.aliyuncs.com/api/v1/services/aigc/image-generation/generation',
    {
      model: 'wanx-inpainting-v1',
      input: {
        image_url: imageUrl,
        mask_url: maskUrl
      },
      parameters: {
        strength: 0.8
      }
    },
    {
      headers: {
        'Authorization': `Bearer ${process.env.DASHSCOPE_API_KEY}`,
        'Content-Type': 'application/json'
      }
    }
  );
  
  return response.data.output.result_url;
}
```

---

## 7. MongoDB Atlas

### 集群信息

```
服务商：MongoDB Atlas（官方托管）
集群名称：Cluster0
集群层级：M0（免费版）
存储容量：512 MB（免费）
共享 RAM：512 MB
共享 vCPU：共享
```

### 地域配置

```
云服务商：AWS
地域：香港 (ap-east-1)
可用区：单区域部署

选择原因：
- 距离中国大陆最近
- 网络延迟低（约 30-50ms）
- 免费层支持

备选地域：
- 新加坡 (ap-southeast-1)
- 东京 (ap-northeast-1)
- 孟买 (ap-south-1)
```

### 数据库凭证

```
连接方式：MongoDB URI
数据库名：imagekit
用户名：imagekit
密码：vO0S5ItuHNM66CMH

完整连接字符串：
mongodb+srv://imagekit:vO0S5ItuHNM66CMH@cluster0.jhqqwf9.mongodb.net/imagekit?retryWrites=true&w=majority

集群域名：cluster0.jhqqwf9.mongodb.net
```

### MongoDB 控制台

```
Atlas 控制台：
https://cloud.mongodb.com/

管理路径：
Database → Cluster0 → Browse Collections

常用功能：
- Browse Collections：查看数据
- Metrics：性能监控
- Network Access：IP 白名单
- Database Access：用户管理
```

### 网络访问配置

```
IP 白名单设置：
- IP 地址：0.0.0.0/0
- 说明：Allow from anywhere
- 添加时间：2025-11-30

⚠️ 安全建议：
生产环境应仅允许服务器 IP：8.152.211.36

修改方法：
Network Access → Edit → 
删除 0.0.0.0/0 → 
添加 8.152.211.36/32
```

### 数据库用户权限

```
用户名：imagekit
用户角色：readWrite（读写权限）
权限范围：imagekit 数据库

具体权限：
- 可读取所有集合（Collections）
- 可写入所有集合
- 可创建索引
- 可修改文档
- 不能删除数据库
- 不能创建新用户

密码管理：
Database Access → Edit User → Edit Password
可随时重新生成密码
```

### 数据库设计（规划）

```javascript
// 1. users 集合（用户表）
{
  _id: ObjectId,
  email: String,              // 邮箱
  name: String,               // 用户名
  googleId: String,           // Google ID
  avatar: String,             // 头像 URL
  vipLevel: Number,           // VIP 等级（0-3）
  credits: Number,            // 剩余点数
  totalCredits: Number,       // 累计点数
  createdAt: Date,            // 注册时间
  updatedAt: Date,            // 更新时间
  lastLoginAt: Date           // 最后登录
}

// 2. images 集合（图片表）
{
  _id: ObjectId,
  userId: ObjectId,           // 用户ID
  originalUrl: String,        // 原始图片 URL
  processedUrl: String,       // 处理后图片 URL
  type: String,               // 处理类型
  status: String,             // 状态
  width: Number,              // 宽度
  height: Number,             // 高度
  fileSize: Number,           // 文件大小
  createdAt: Date,            // 创建时间
  processedAt: Date           // 处理完成时间
}

// 3. transactions 集合（交易记录）
{
  _id: ObjectId,
  userId: ObjectId,           // 用户ID
  type: String,               // 类型
  amount: Number,             // 金额
  credits: Number,            // 点数
  status: String,             // 状态
  paymentMethod: String,      // 支付方式
  createdAt: Date             // 创建时间
}
```

### 索引设计

```javascript
// users 集合索引
db.users.createIndex({ email: 1 }, { unique: true });
db.users.createIndex({ googleId: 1 });

// images 集合索引
db.images.createIndex({ userId: 1, createdAt: -1 });
db.images.createIndex({ status: 1 });

// transactions 集合索引
db.transactions.createIndex({ userId: 1, createdAt: -1 });
db.transactions.createIndex({ status: 1 });
```

### 备份策略

```
免费版备份：
- 自动快照：保留 24 小时
- 恢复点：最近 24 小时内任意时间点
- 频率：连续备份

付费版备份（可选升级）：
- 连续备份：7-35 天可选
- 时间点恢复：任意时间点
- 快照频率：可自定义
```

### Mongoose 连接示例

```javascript
const mongoose = require('mongoose');

const connectDB = async () => {
  try {
    await mongoose.connect(process.env.MONGODB_URI, {
      useNewUrlParser: true,
      useUnifiedTopology: true,
    });
    console.log('✅ MongoDB 连接成功');
  } catch (error) {
    console.error('❌ MongoDB 连接失败:', error);
    process.exit(1);
  }
};

module.exports = connectDB;
```

### 性能监控

```
Atlas 提供的监控指标：
- 操作数（Operations）
- 网络流量（Network）
- 连接数（Connections）
- 查询执行时间（Query Execution Time）
- 磁盘使用率（Disk Usage）

查看路径：
Cluster0 → Metrics → 选择时间范围
```

---

## 8. Google OAuth

### Google Cloud 项目

```
项目名称：ImageKit
项目 ID：dogwood-flames-454708-c1
项目编号：701560469139

Google Cloud Console：
https://console.cloud.google.com/

项目选择：
顶部项目下拉框 → ImageKit
```

### OAuth 凭据

```
应用类型：Web 应用
客户端名称：ImageKit Web

客户端 ID：
your_google_client_id

客户端密钥：
your_google_client_secret

创建时间：2025-11-30

⚠️ 安全提示：
- 客户端密钥存储在后端 .env
- 不要暴露在前端代码中
- 可在控制台重新生成
- 定期检查访问日志
```

### OAuth 同意屏幕配置

```
应用名称：ImageKit
用户类型：外部（External）
发布状态：测试中（Testing）

应用信息：
- 应用首页：https://getimagekit.com
- 应用隐私政策：https://getimagekit.com/privacy
- 应用服务条款：https://getimagekit.com/terms
- 授权网域：getimagekit.com

联系信息：
- 用户支持邮箱：gaozhenglong99@gmail.com
- 开发者联系邮箱：gaozhenglong99@gmail.com

配置路径：
API 和服务 → OAuth 同意屏幕
https://console.cloud.google.com/apis/credentials/consent
```

### 授权范围（Scopes）

```
已申请的权限：

1. https://www.googleapis.com/auth/userinfo.email
   说明：查看用户的电子邮件地址
   敏感度：敏感
   
2. https://www.googleapis.com/auth/userinfo.profile
   说明：查看用户的个人资料信息
   包括：姓名、头像、性别等
   敏感度：敏感
   
3. openid
   说明：OpenID Connect 标准
   用于身份验证

隐私说明：
- 仅获取用户基本信息
- 不访问 Gmail、Drive 等敏感数据
- 用户可随时取消授权
```

### 已获授权的 JavaScript 来源

```
生产环境：
- https://www.getimagekit.com
- https://getimagekit.com

开发环境：
- http://localhost:5173（Vite 前端）
- http://localhost:3000（Node.js 后端）

说明：
允许这些域名的网页调用 Google 登录弹窗
```

### 已获授权的重定向 URI

```
⚠️ 需要修改为正确配置！

当前配置（错误）：
❌ https://www.getimagekit.com
❌ https://getimagekit.com
❌ http://localhost:3000

应该修改为（正确）：
✅ https://api.getimagekit.com/api/auth/google/callback
✅ http://localhost:3000/api/auth/google/callback

修改方法：
1. 访问 https://console.cloud.google.com/apis/credentials
2. 点击 OAuth 客户端 ID "ImageKit Web"
3. 点击右上角"编辑"
4. 在"已获授权的重定向 URI"部分：
   - 删除错误的 3 个 URI
   - 添加正确的 2 个回调地址
5. 点击"保存"
6. 等待 5 分钟生效
```

### OAuth 登录流程

```
完整流程：

1. 前端发起登录
   用户点击"使用 Google 登录"
   
2. 跳转到 Google 授权页面
   URL: https://accounts.google.com/o/oauth2/v2/auth
   参数：client_id, redirect_uri, scope, state
   
3. 用户同意授权
   查看权限列表
   点击"允许"
   
4. Google 重定向到回调地址
   回调：https://api.getimagekit.com/api/auth/google/callback?code=xxxxx
   
5. 后端换取 Access Token
   POST https://oauth2.googleapis.com/token
   参数：code, client_id, client_secret, redirect_uri
   
6. 后端获取用户信息
   GET https://www.googleapis.com/oauth2/v1/userinfo
   Headers: Authorization: Bearer {access_token}
   
7. 后端创建/更新用户
   查询数据库是否存在该 googleId
   存在则更新，不存在则创建
   
8. 后端生成 JWT Token
   使用 JWT_SECRET 签名
   有效期：7 天
   
9. 返回给前端
   返回：{ token, user }
   
10. 前端保存 Token
    localStorage.setItem('token', token)
    
11. 登录完成
    跳转到用户工作台
```

### 测试用户

```
开发阶段测试用户列表：
- gaozhenglong99@gmail.com

添加测试用户：
OAuth 同意屏幕 → 测试用户 → 添加用户

说明：
- 测试阶段只有测试用户可以登录
- 每个 Google 项目最多 100 个测试用户
- 发布后所有 Google 用户都可以登录
```

### 发布流程（未来）

```
将应用发布到生产环境：

1. 完善应用信息
   - 上传应用徽标（120x120 px）
   - 填写详细的应用说明
   - 提供隐私政策和服务条款链接

2. 提交审核
   OAuth 同意屏幕 → 发布应用
   
3. Google 审核（1-3 周）
   - 审核应用安全性
   - 检查隐私政策合规性
   - 验证授权范围合理性

4. 审核通过
   - 应用状态变为"已发布"
   - 所有用户都可以登录
   - 取消测试用户限制

5. 定期审核
   - Google 会定期审核已发布应用
   - 需要保持合规
```

### Passport.js 配置示例

```javascript
const passport = require('passport');
const GoogleStrategy = require('passport-google-oauth20').Strategy;

passport.use(new GoogleStrategy({
    clientID: process.env.GOOGLE_CLIENT_ID,
    clientSecret: process.env.GOOGLE_CLIENT_SECRET,
    callbackURL: process.env.GOOGLE_CALLBACK_URL
  },
  async (accessToken, refreshToken, profile, done) => {
    try {
      // 查找或创建用户
      let user = await User.findOne({ googleId: profile.id });
      
      if (!user) {
        user = await User.create({
          googleId: profile.id,
          email: profile.emails[0].value,
          name: profile.displayName,
          avatar: profile.photos[0].value
        });
      }
      
      done(null, user);
    } catch (error) {
      done(error, null);
    }
  }
));
```

### 凭据管理地址

```
OAuth 客户端 ID 管理：
https://console.cloud.google.com/apis/credentials

OAuth 同意屏幕配置：
https://console.cloud.google.com/apis/credentials/consent

API 库（启用 API）：
https://console.cloud.google.com/apis/library
```

---

## 9. 敏感信息汇总

### 服务器信息

```
服务器 IP：8.152.211.36
服务器位置：阿里云 ECS 华东1（杭州）
操作系统：CentOS
SSH 端口：22（默认）

⚠️ 安全建议：
- 使用密钥登录，禁用密码登录
- 修改 SSH 默认端口
- 配置防火墙规则
- 定期更新系统补丁
```

### 阿里云 OSS

```
Bucket：imagekit-temp
AccessKey ID：your_access_key_id
AccessKey Secret：your_access_key_secret
Endpoint：https://oss-cn-hangzhou.aliyuncs.com
```

### 阿里云百炼平台

```
API Key：sk-1c8f2ce9054d4b298878faef7335dc24
API Endpoint：https://dashscope.aliyuncs.com/api/v1/
```

### MongoDB Atlas

```
连接字符串：
mongodb+srv://imagekit:vO0S5ItuHNM66CMH@cluster0.jhqqwf9.mongodb.net/imagekit?retryWrites=true&w=majority

用户名：imagekit
密码：vO0S5ItuHNM66CMH
集群域名：cluster0.jhqqwf9.mongodb.net
数据库名：imagekit
```

### Google OAuth

```
Client ID：
your_google_client_id

Client Secret：
your_google_client_secret

项目 ID：dogwood-flames-454708-c1
```

### JWT 配置

```
JWT Secret：imagekit-dev-secret-key-please-change-in-production
Session Secret：imagekit-session-secret

⚠️ 生产环境建议：
生成强随机密钥：
node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"
```

### 完整 .env 文件

```bash
# ====================================
# ImageKit Backend Environment Variables
# ====================================

# 服务器配置
NODE_ENV=development
PORT=3000
FRONTEND_URL=https://getimagekit.com
FRONTEND_URL_DEV=http://localhost:5173

# ====================================
# 数据库配置 (MongoDB Atlas)
# ====================================
MONGODB_URI=mongodb+srv://imagekit:vO0S5ItuHNM66CMH@cluster0.jhqqwf9.mongodb.net/imagekit?retryWrites=true&w=majority

# ====================================
# JWT 配置
# ====================================
JWT_SECRET=imagekit-dev-secret-key-please-change-in-production

# ====================================
# 阿里云 OSS 配置
# ====================================
ALIYUN_OSS_ACCESS_KEY_ID=your_access_key_id
ALIYUN_OSS_ACCESS_KEY_SECRET=your_access_key_secret
ALIYUN_OSS_REGION=oss-cn-hangzhou
ALIYUN_OSS_BUCKET=imagekit-temp
ALIYUN_OSS_ENDPOINT=https://oss-cn-hangzhou.aliyuncs.com

# ====================================
# 阿里云百炼平台 (AI 图片处理)
# ====================================
DASHSCOPE_API_KEY=sk-1c8f2ce9054d4b298878faef7335dc24

# ====================================
# Google OAuth 配置
# ====================================
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
GOOGLE_CALLBACK_URL=https://api.getimagekit.com/api/auth/google/callback
GOOGLE_CALLBACK_URL_DEV=http://localhost:3000/api/auth/google/callback

# ====================================
# 其他配置
# ====================================
MAX_FILE_SIZE=20
SESSION_SECRET=imagekit-session-secret
ALLOWED_ORIGINS=https://getimagekit.com,https://www.getimagekit.com,http://localhost:5173
```

### 安全建议

```
✅ 必须做：
1. 不要将 .env 文件提交到 Git
   在 .gitignore 中添加：.env

2. 不要在前端代码中暴露任何密钥

3. 使用环境变量存储所有敏感信息

4. 定期轮换密钥（建议每 90 天）

5. 使用强密码和随机密钥

6. 限制 IP 白名单（生产环境）

7. 启用 HTTPS 加密传输

8. 监控异常访问日志

⚠️ 如果密钥泄露：
1. 立即在控制台重新生成
2. 更新服务器 .env 文件
3. 重启相关服务
4. 检查访问日志
5. 评估安全风险
```

---

## 10. 待处理事项

### 紧急（必须完成）

```
1. ❗ 修改 Google OAuth 重定向 URI
   状态：未完成
   优先级：P0（最高）
   
   操作步骤：
   a. 访问 https://console.cloud.google.com/apis/credentials
   b. 点击 OAuth 客户端 "ImageKit Web"
   c. 删除错误的 redirect_uris
   d. 添加正确的回调地址：
      - https://api.getimagekit.com/api/auth/google/callback
      - http://localhost:3000/api/auth/google/callback
   e. 保存并等待 5 分钟生效
   
   截止日期：立即完成
```

### 重要（近期完成）

```
2. 📝 完善隐私政策和服务条款页面
   状态：未开始
   优先级：P1
   
   需要创建的页面：
   - https://getimagekit.com/privacy（隐私政策）
   - https://getimagekit.com/terms（服务条款）
   
   内容要求：
   - 符合 GDPR 和中国个人信息保护法
   - 说明数据收集和使用方式
   - 说明用户权利
   - 说明服务条款和免责声明
   
   截止日期：2025-12-15

3. 🔐 修改 JWT_SECRET 为强随机密钥
   状态：未完成
   优先级：P1
   
   生成命令：
   node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"
   
   截止日期：部署前
```

### 定期维护

```
4. 📅 SSL 证书续期提醒
   状态：未到期
   优先级：P2
   
   提醒日期：2026-01-28
   到期日期：2026-02-28
   
   续期步骤：
   a. SSH 登录服务器
   b. 执行：sudo certbot renew --manual
   c. 按提示添加 DNS TXT 记录
   d. 等待验证通过
   e. 重新加载 Nginx：sudo /usr/local/nginx/sbin/nginx -s reload
   
   设置日历提醒：2026-01-28

5. 🔄 定期轮换密钥（90天）
   状态：未到期
   优先级：P2
   
   需要轮换的密钥：
   - 阿里云 OSS AccessKey
   - 阿里云百炼 API Key
   - Google OAuth Client Secret
   - JWT Secret
   - MongoDB 数据库密码
   
   下次轮换日期：2026-03-01
```

### 优化改进

```
6. 💰 阿里云百炼平台充值
   状态：未充值（可能有试用额度）
   优先级：P3
   
   建议充值：10-50 元
   充值入口：https://bailian.console.aliyun.com/
   
   截止日期：测试完成后

7. 🔒 MongoDB IP 白名单优化
   状态：当前允许所有 IP（0.0.0.0/0）
   优先级：P3
   
   生产环境建议：
   仅允许服务器 IP：8.152.211.36/32
   
   修改位置：
   MongoDB Atlas → Network Access → Edit
   
   截止日期：部署生产环境前

8. 📊 配置监控和日志
   状态：未配置
   优先级：P3
   
   推荐工具：
   - 阿里云日志服务（SLS）
   - MongoDB Atlas Alerts
   - Google Cloud Monitoring
   
   截止日期：2025-12-31
```

---

## 📊 配置完成度总览

### 总体进度

```
✅ 域名配置：        100% ████████████████████
✅ DNS 解析：        100% ████████████████████
✅ SSL 证书：        100% ████████████████████
✅ Nginx 服务器：    100% ████████████████████
✅ 阿里云 OSS：      100% ████████████████████
✅ 阿里云百炼：      100% ████████████████████
✅ MongoDB Atlas：   100% ████████████████████
⚠️ Google OAuth：    95%  ███████████████████░

总体完成度：98.75%
```

### 各服务状态

| 服务 | 状态 | 完成度 | 备注 |
|------|------|--------|------|
| 域名 | ✅ 正常 | 100% | 已完成 |
| DNS | ✅ 正常 | 100% | 已生效 |
| SSL | ✅ 正常 | 100% | 2026-02-28 到期 |
| Nginx | ✅ 运行中 | 100% | 监听 80/443 |
| OSS | ✅ 正常 | 100% | 已配置 CORS |
| 百炼 | ✅ 正常 | 100% | API Key 有效 |
| MongoDB | ✅ 正常 | 100% | 香港集群 |
| OAuth | ⚠️ 需修改 | 95% | 重定向 URI 错误 |

---

## 🎯 下一步工作

### 立即开始

```
1. 修改 Google OAuth 重定向 URI（5分钟）
2. 初始化后端项目（20分钟）
3. 安装 Node.js 依赖（10分钟）
4. 编写后端核心代码（2小时）
5. 本地测试 API（30分钟）
```

### 本周完成

```
6. 完善前端用户认证（1小时）
7. 集成图片上传功能（2小时）
8. 集成 AI 图片处理（3小时）
9. 前后端联调测试（1小时）
10. 部署到生产服务器（1小时）
```

### 本月完成

```
11. 编写隐私政策和服务条款
12. 实现 VIP 会员系统
13. 实现积分充值系统
14. 配置监控告警
15. 性能优化和压力测试
16. 准备上线发布
```

---

## 📚 相关文档链接

### 阿里云文档

```
域名服务：https://help.aliyun.com/product/35473.html
DNS 服务：https://help.aliyun.com/product/29697.html
OSS 文档：https://help.aliyun.com/product/31815.html
百炼平台：https://help.aliyun.com/zh/model-studio/
ECS 文档：https://help.aliyun.com/product/25365.html
```

### 第三方服务文档

```
MongoDB Atlas：https://www.mongodb.com/docs/atlas/
Google OAuth：https://developers.google.com/identity/protocols/oauth2
Let's Encrypt：https://letsencrypt.org/docs/
Nginx 文档：https://nginx.org/en/docs/
```

### 开发框架文档

```
Node.js：https://nodejs.org/docs/
Express：https://expressjs.com/
Mongoose：https://mongoosejs.com/docs/
Passport.js：http://www.passportjs.org/docs/
React：https://react.dev/
Vite：https://vitejs.dev/
```

---

## 💡 技术支持

### 遇到问题时的解决流程

```
1. 查看错误日志
   - Nginx 日志：/usr/local/nginx/logs/error.log
   - 后端日志：console.log 输出
   - 浏览器控制台：F12 查看

2. 搜索官方文档
   - 根据错误信息搜索
   - 查看 API 文档示例

3. 检查配置文件
   - .env 文件是否正确
   - Nginx 配置是否生效
   - 防火墙规则是否允许

4. 在线求助
   - Stack Overflow
   - GitHub Issues
   - 官方社区论坛

5. 联系技术支持
   - 阿里云工单系统
   - MongoDB Support
   - Google Cloud Support
```

### 常见问题 FAQ

```
Q1: Nginx 启动失败怎么办？
A1: 执行 sudo /usr/local/nginx/sbin/nginx -t 检查配置语法

Q2: MongoDB 连接超时？
A2: 检查 IP 白名单，确认服务器 IP 已添加

Q3: OSS 上传失败？
A3: 检查 CORS 配置，确认域名在白名单中

Q4: Google 登录报错 redirect_uri_mismatch？
A4: 检查 OAuth 配置中的重定向 URI 是否正确

Q5: SSL 证书过期了怎么办？
A5: 执行 sudo certbot renew --manual 重新申请
```

---

## ✅ 配置验证清单

### 最终检查（上线前必做）

```
□ 所有域名可以正常访问
□ HTTPS 证书有效且未过期
□ Nginx 正常运行，监听 80 和 443 端口
□ OSS 可以正常上传和访问文件
□ MongoDB 连接正常，可以读写数据
□ Google OAuth 登录流程完整可用
□ 所有 API 接口正常响应
□ 前后端通信正常
□ 图片处理功能正常
□ 支付功能正常（如果有）
□ 监控告警已配置
□ 日志记录正常
□ 备份策略已实施
□ 安全措施已到位
□ 性能测试通过
□ 用户体验良好
```

---

**文档版本：** v1.0  
**最后更新：** 2025-11-30 22:25  
**维护人员：** 卡卡老板  

**⚠️ 重要提示：**
本文档包含敏感信息，请妥善保管，不要上传到公开的代码仓库！
