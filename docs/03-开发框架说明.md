# ImageKit 开发框架说明

## 1. 项目初始化

### 1.1 创建项目

```bash
# 使用 Vite 创建 React + TypeScript 项目
npm create vite@latest ImageKit -- --template react-ts

cd ImageKit
npm install
```

### 1.2 安装核心依赖

```bash
# UI 框架
npm install tailwindcss postcss autoprefixer
npx tailwindcss init -p

# shadcn/ui (按需安装组件)
npx shadcn-ui@latest init

# 状态管理
npm install zustand

# 图片处理
npm install browser-image-compression fabric jszip file-saver

# 文件上传
npm install react-dropzone

# 路由
npm install react-router-dom

# 图标
npm install lucide-react

# 工具库
npm install clsx tailwind-merge

# 类型定义
npm install -D @types/fabric @types/file-saver
```

### 1.3 安装开发依赖

```bash
# 测试
npm install -D vitest @testing-library/react @testing-library/jest-dom

# SEO
npm install react-helmet-async

# 分析工具
npm install -D @vitejs/plugin-react
```

---

## 2. 配置文件

### 2.1 Vite 配置（vite.config.ts）

```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import path from 'path';

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
  build: {
    // 分块策略
    rollupOptions: {
      output: {
        manualChunks: {
          'react-vendor': ['react', 'react-dom', 'react-router-dom'],
          'image-processing': ['browser-image-compression', 'fabric', 'jszip'],
        },
      },
    },
    // 警告大小限制
    chunkSizeWarningLimit: 1000,
  },
  server: {
    port: 3000,
    open: true,
  },
});
```

### 2.2 TypeScript 配置（tsconfig.json）

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,

    /* Path alias */
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}
```

### 2.3 TailwindCSS 配置（tailwind.config.js）

```javascript
/** @type {import('tailwindcss').Config} */
export default {
  darkMode: ["class"],
  content: [
    './pages/**/*.{ts,tsx}',
    './components/**/*.{ts,tsx}',
    './app/**/*.{ts,tsx}',
    './src/**/*.{ts,tsx}',
  ],
  theme: {
    container: {
      center: true,
      padding: "2rem",
      screens: {
        "2xl": "1400px",
      },
    },
    extend: {
      colors: {
        border: "hsl(var(--border))",
        input: "hsl(var(--input))",
        ring: "hsl(var(--ring))",
        background: "hsl(var(--background))",
        foreground: "hsl(var(--foreground))",
        primary: {
          DEFAULT: "hsl(var(--primary))",
          foreground: "hsl(var(--primary-foreground))",
        },
        secondary: {
          DEFAULT: "hsl(var(--secondary))",
          foreground: "hsl(var(--secondary-foreground))",
        },
        destructive: {
          DEFAULT: "hsl(var(--destructive))",
          foreground: "hsl(var(--destructive-foreground))",
        },
        muted: {
          DEFAULT: "hsl(var(--muted))",
          foreground: "hsl(var(--muted-foreground))",
        },
        accent: {
          DEFAULT: "hsl(var(--accent))",
          foreground: "hsl(var(--accent-foreground))",
        },
        popover: {
          DEFAULT: "hsl(var(--popover))",
          foreground: "hsl(var(--popover-foreground))",
        },
        card: {
          DEFAULT: "hsl(var(--card))",
          foreground: "hsl(var(--card-foreground))",
        },
      },
      borderRadius: {
        lg: "var(--radius)",
        md: "calc(var(--radius) - 2px)",
        sm: "calc(var(--radius) - 4px)",
      },
      keyframes: {
        "accordion-down": {
          from: { height: 0 },
          to: { height: "var(--radix-accordion-content-height)" },
        },
        "accordion-up": {
          from: { height: "var(--radix-accordion-content-height)" },
          to: { height: 0 },
        },
      },
      animation: {
        "accordion-down": "accordion-down 0.2s ease-out",
        "accordion-up": "accordion-up 0.2s ease-out",
      },
    },
  },
  plugins: [require("tailwindcss-animate")],
}
```

### 2.4 PostCSS 配置（postcss.config.js）

```javascript
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
```

---

## 3. shadcn/ui 组件集成

### 3.1 初始化 shadcn/ui

```bash
npx shadcn-ui@latest init
```

选择配置：
- TypeScript: Yes
- Style: Default
- Base color: Slate
- Global CSS: src/index.css
- CSS variables: Yes
- Tailwind config: tailwind.config.js
- Components: src/components
- Utils: src/lib/utils.ts
- React Server Components: No

### 3.2 安装常用组件

```bash
# 按钮
npx shadcn-ui@latest add button

# 卡片
npx shadcn-ui@latest add card

# 输入框
npx shadcn-ui@latest add input

# 滑块
npx shadcn-ui@latest add slider

# 下拉菜单
npx shadcn-ui@latest add dropdown-menu

# 标签页
npx shadcn-ui@latest add tabs

# 对话框
npx shadcn-ui@latest add dialog

# 进度条
npx shadcn-ui@latest add progress

# 提示
npx shadcn-ui@latest add tooltip

# 徽章
npx shadcn-ui@latest add badge

# 开关
npx shadcn-ui@latest add switch

# 加载动画
npx shadcn-ui@latest add skeleton
```

---

## 4. 全局样式配置

### 4.1 index.css

```css
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  :root {
    --background: 0 0% 100%;
    --foreground: 222.2 84% 4.9%;

    --card: 0 0% 100%;
    --card-foreground: 222.2 84% 4.9%;

    --popover: 0 0% 100%;
    --popover-foreground: 222.2 84% 4.9%;

    --primary: 222.2 47.4% 11.2%;
    --primary-foreground: 210 40% 98%;

    --secondary: 210 40% 96.1%;
    --secondary-foreground: 222.2 47.4% 11.2%;

    --muted: 210 40% 96.1%;
    --muted-foreground: 215.4 16.3% 46.9%;

    --accent: 210 40% 96.1%;
    --accent-foreground: 222.2 47.4% 11.2%;

    --destructive: 0 84.2% 60.2%;
    --destructive-foreground: 210 40% 98%;

    --border: 214.3 31.8% 91.4%;
    --input: 214.3 31.8% 91.4%;
    --ring: 222.2 84% 4.9%;

    --radius: 0.5rem;
  }

  .dark {
    --background: 222.2 84% 4.9%;
    --foreground: 210 40% 98%;

    --card: 222.2 84% 4.9%;
    --card-foreground: 210 40% 98%;

    --popover: 222.2 84% 4.9%;
    --popover-foreground: 210 40% 98%;

    --primary: 210 40% 98%;
    --primary-foreground: 222.2 47.4% 11.2%;

    --secondary: 217.2 32.6% 17.5%;
    --secondary-foreground: 210 40% 98%;

    --muted: 217.2 32.6% 17.5%;
    --muted-foreground: 215 20.2% 65.1%;

    --accent: 217.2 32.6% 17.5%;
    --accent-foreground: 210 40% 98%;

    --destructive: 0 62.8% 30.6%;
    --destructive-foreground: 210 40% 98%;

    --border: 217.2 32.6% 17.5%;
    --input: 217.2 32.6% 17.5%;
    --ring: 212.7 26.8% 83.9%;
  }
}

@layer base {
  * {
    @apply border-border;
  }
  body {
    @apply bg-background text-foreground;
  }
}
```

---

## 5. 常量配置

### 5.1 config.ts

```typescript
// src/constants/config.ts

export const APP_CONFIG = {
  name: 'ImageKit',
  description: '免费在线图片处理工具',
  url: 'https://imagekit.com',
  author: '卡卡老板',
  version: '1.0.0',
};

export const IMAGE_CONFIG = {
  // 支持的图片格式
  supportedFormats: ['image/jpeg', 'image/png', 'image/webp', 'image/bmp'],
  
  // 文件大小限制（字节）
  maxFileSize: 10 * 1024 * 1024, // 10MB
  
  // 批量处理最大数量
  maxBatchCount: 100,
  
  // 默认压缩质量
  defaultQuality: 80,
  
  // 预设尺寸
  presetSizes: [
    { label: '社交媒体 - Instagram 正方形', width: 1080, height: 1080 },
    { label: '社交媒体 - Instagram 竖版', width: 1080, height: 1350 },
    { label: '社交媒体 - 微信公众号封面', width: 900, height: 500 },
    { label: 'Full HD', width: 1920, height: 1080 },
    { label: 'HD', width: 1280, height: 720 },
    { label: '电商商品图', width: 800, height: 800 },
  ],
  
  // 预设裁剪比例
  presetAspectRatios: [
    { label: '1:1 (正方形)', value: 1 },
    { label: '4:3', value: 4/3 },
    { label: '16:9', value: 16/9 },
    { label: '3:2', value: 3/2 },
    { label: '9:16 (竖屏)', value: 9/16 },
  ],
};

export const TOOL_CONFIG = {
  compress: {
    id: 'compress',
    name: '图片压缩',
    description: '减小文件大小，不损失画质',
    icon: 'Minimize2',
    path: '/compress',
  },
  convert: {
    id: 'convert',
    name: '格式转换',
    description: 'JPG、PNG、WebP 互转',
    icon: 'RefreshCw',
    path: '/convert',
  },
  resize: {
    id: 'resize',
    name: '调整大小',
    description: '修改图片尺寸',
    icon: 'Maximize2',
    path: '/resize',
  },
  crop: {
    id: 'crop',
    name: '图片裁剪',
    description: '裁剪图片区域',
    icon: 'Crop',
    path: '/crop',
  },
  rotate: {
    id: 'rotate',
    name: '旋转翻转',
    description: '旋转或翻转图片',
    icon: 'RotateCw',
    path: '/rotate',
  },
};
```

---

## 6. 工具函数

### 6.1 utils.ts (shadcn/ui 自带)

```typescript
// src/lib/utils.ts

import { type ClassValue, clsx } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}
```

### 6.2 文件验证工具

```typescript
// src/utils/fileValidator.ts

import { IMAGE_CONFIG } from '@/constants/config';
import { ImageKitError, ErrorCode } from '@/types/error';

/**
 * 验证文件是否为有效图片
 */
export function validateImageFile(file: File): void {
  // 检查文件类型
  if (!IMAGE_CONFIG.supportedFormats.includes(file.type)) {
    throw new ImageKitError(
      ErrorCode.INVALID_FORMAT,
      `不支持的图片格式: ${file.type}`
    );
  }
  
  // 检查文件大小
  if (file.size > IMAGE_CONFIG.maxFileSize) {
    throw new ImageKitError(
      ErrorCode.FILE_TOO_LARGE,
      `文件过大: ${formatFileSize(file.size)}，最大支持 ${formatFileSize(IMAGE_CONFIG.maxFileSize)}`
    );
  }
}

/**
 * 批量验证文件
 */
export function validateImageFiles(files: File[]): {
  valid: File[];
  invalid: Array<{ file: File; error: string }>;
} {
  const valid: File[] = [];
  const invalid: Array<{ file: File; error: string }> = [];
  
  files.forEach(file => {
    try {
      validateImageFile(file);
      valid.push(file);
    } catch (error) {
      invalid.push({
        file,
        error: error instanceof Error ? error.message : '未知错误',
      });
    }
  });
  
  return { valid, invalid };
}

/**
 * 格式化文件大小
 */
export function formatFileSize(bytes: number): string {
  if (bytes === 0) return '0 B';
  
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  
  return `${(bytes / Math.pow(k, i)).toFixed(2)} ${sizes[i]}`;
}

/**
 * 获取文件扩展名
 */
export function getFileExtension(filename: string): string {
  return filename.slice(filename.lastIndexOf('.') + 1).toLowerCase();
}

/**
 * 生成唯一文件名
 */
export function generateUniqueFilename(originalName: string, suffix?: string): string {
  const ext = getFileExtension(originalName);
  const name = originalName.slice(0, originalName.lastIndexOf('.'));
  const timestamp = Date.now();
  
  return suffix 
    ? `${name}_${suffix}.${ext}`
    : `${name}_${timestamp}.${ext}`;
}
```

---

## 7. 类型定义

### 7.1 image.ts

```typescript
// src/types/image.ts

export interface ProcessedImage {
  id: string;
  originalFile: File;
  originalUrl: string;
  originalSize: number;
  originalWidth?: number;
  originalHeight?: number;
  
  processedUrl?: string;
  processedSize?: number;
  processedWidth?: number;
  processedHeight?: number;
  
  compressionRatio?: number;
  
  status: 'pending' | 'processing' | 'completed' | 'error';
  error?: string;
  
  metadata?: Record<string, any>;
}

export interface ImageDimensions {
  width: number;
  height: number;
}

export interface ImageMetadata {
  format: string;
  size: number;
  dimensions: ImageDimensions;
  createdAt: Date;
}
```

### 7.2 tool.ts

```typescript
// src/types/tool.ts

export type ToolType = 'compress' | 'convert' | 'resize' | 'crop' | 'rotate';

export interface Tool {
  id: ToolType;
  name: string;
  description: string;
  icon: string;
  path: string;
}

export interface ToolOptions {
  compress?: {
    quality: number;
    maxSizeMB?: number;
  };
  convert?: {
    format: 'jpeg' | 'png' | 'webp' | 'bmp';
    quality?: number;
  };
  resize?: {
    width?: number;
    height?: number;
    scale?: number;
    keepAspectRatio: boolean;
  };
  crop?: {
    x: number;
    y: number;
    width: number;
    height: number;
  };
  rotate?: {
    angle: number;
    flipHorizontal: boolean;
    flipVertical: boolean;
  };
}
```

### 7.3 error.ts

```typescript
// src/types/error.ts

export enum ErrorCode {
  FILE_TOO_LARGE = 'FILE_TOO_LARGE',
  INVALID_FORMAT = 'INVALID_FORMAT',
  PROCESSING_FAILED = 'PROCESSING_FAILED',
  BROWSER_NOT_SUPPORTED = 'BROWSER_NOT_SUPPORTED',
  OUT_OF_MEMORY = 'OUT_OF_MEMORY',
}

export class ImageKitError extends Error {
  code: ErrorCode;
  
  constructor(code: ErrorCode, message: string) {
    super(message);
    this.code = code;
    this.name = 'ImageKitError';
  }
}

export const ERROR_MESSAGES: Record<ErrorCode, string> = {
  [ErrorCode.FILE_TOO_LARGE]: '文件过大，请选择小于 10MB 的图片',
  [ErrorCode.INVALID_FORMAT]: '不支持的图片格式，请上传 JPG/PNG/WebP',
  [ErrorCode.PROCESSING_FAILED]: '处理失败，请重试',
  [ErrorCode.BROWSER_NOT_SUPPORTED]: '您的浏览器版本过低，请升级浏览器',
  [ErrorCode.OUT_OF_MEMORY]: '图片过大导致内存不足，请减小图片尺寸',
};
```

---

## 8. 环境检测

### 8.1 浏览器兼容性检测

```typescript
// src/utils/browserDetect.ts

export function checkBrowserSupport(): {
  supported: boolean;
  missing: string[];
} {
  const missing: string[] = [];
  
  // 检查 Canvas API
  if (!document.createElement('canvas').getContext) {
    missing.push('Canvas API');
  }
  
  // 检查 File API
  if (!window.File || !window.FileReader || !window.FileList || !window.Blob) {
    missing.push('File API');
  }
  
  // 检查 URL API
  if (!window.URL || !window.URL.createObjectURL) {
    missing.push('URL API');
  }
  
  // 检查 Web Workers (可选)
  if (!window.Worker) {
    console.warn('Web Workers not supported, may impact performance');
  }
  
  return {
    supported: missing.length === 0,
    missing,
  };
}

/**
 * 获取浏览器信息
 */
export function getBrowserInfo(): {
  name: string;
  version: string;
} {
  const ua = navigator.userAgent;
  let name = 'Unknown';
  let version = 'Unknown';
  
  if (ua.indexOf('Chrome') > -1) {
    name = 'Chrome';
    version = ua.match(/Chrome\/(\d+)/)?.[1] || 'Unknown';
  } else if (ua.indexOf('Safari') > -1) {
    name = 'Safari';
    version = ua.match(/Version\/(\d+)/)?.[1] || 'Unknown';
  } else if (ua.indexOf('Firefox') > -1) {
    name = 'Firefox';
    version = ua.match(/Firefox\/(\d+)/)?.[1] || 'Unknown';
  } else if (ua.indexOf('Edge') > -1) {
    name = 'Edge';
    version = ua.match(/Edge\/(\d+)/)?.[1] || 'Unknown';
  }
  
  return { name, version };
}
```

---

## 9. Git 配置

### 9.1 .gitignore

```
# Dependencies
node_modules/

# Production
dist/
build/

# Environment
.env
.env.local
.env.production

# IDE
.vscode/
.idea/
*.swp
*.swo

# OS
.DS_Store
Thumbs.db

# Logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# Test
coverage/

# Misc
.cache/
```

---

## 10. package.json 脚本

```json
{
  "name": "imagekit",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview",
    "test": "vitest",
    "test:ui": "vitest --ui",
    "lint": "eslint . --ext ts,tsx --report-unused-disable-directives --max-warnings 0",
    "format": "prettier --write \"src/**/*.{ts,tsx,css,md}\""
  }
}
```

---

**文档版本**：v1.0  
**创建时间**：2024-11-30  
**更新时间**：2024-11-30
